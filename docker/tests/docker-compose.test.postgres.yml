# Docker Compose for Isolated Test Environment - PostgreSQL
# Ports: inference-core-test:8100, redis-test:6380, postgres-test:55432
# Usage: docker compose -f docker/tests/docker-compose.test.postgres.yml --env-file .env.test.example up -d
# Cleanup: docker compose -f docker/tests/docker-compose.test.postgres.yml down -v

name: ${APP_NAME:-inference-core-test}-postgres

services:
  # Inference Core Application (Test)
  inference-core-test:
    build:
      context: ../..
      dockerfile: docker/tests/Dockerfile
    container_name: ${APP_NAME:-inference-core-test}-api
    restart: unless-stopped
    command:
      [
        'uvicorn',
        'inference_core.main_factory:create_application',
        '--factory',
        '--port',
        '${PORT:-8100}',
        '--host',
        '${HOST:-0.0.0.0}',
        '--workers',
        '2',
      ]
    ports:
      - '${PORT:-8100}:${PORT:-8100}'
    environment:
      ENVIRONMENT: testing
      APP_NAME: ${APP_NAME:-inference-core-test}
      APP_DESCRIPTION: ${APP_DESCRIPTION:-Test environment for Inference Core backend}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      DATABASE_SERVICE: postgresql+asyncpg
      DATABASE_HOST: postgres-test
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-test_db}
      DATABASE_USER: ${DATABASE_USER:-test_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-test_password}
      CELERY_BROKER_URL: redis://redis-test:${REDIS_PORT:-6380}/0
      CELERY_RESULT_BACKEND: redis://redis-test:${REDIS_PORT:-6380}/1
      REDIS_URL: redis://redis-test:${REDIS_PORT:-6380}/10
      SECRET_KEY: ${SECRET_KEY:-test-secret-key-do-not-use-in-production}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      REDIS_REFRESH_PREFIX: ${REDIS_REFRESH_PREFIX:-test:auth:refresh:}
      RUN_LLM_REAL_TESTS: ${RUN_LLM_REAL_TESTS:-0}
      DEBUG: ${DEBUG:-false}
    networks:
      - test-network
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          'http://localhost:${PORT:-8100}/api/v1/health/ping',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Celery Worker (Test)
  celery-worker-test:
    build:
      context: ../..
      dockerfile: docker/tests/Dockerfile
    container_name: ${APP_NAME:-inference-core-test}-celery-worker
    restart: unless-stopped
    command: >
      sh -c "poetry run celery -A inference_core.celery.celery_main:celery_app worker 
             --loglevel=info 
             --queues=default,llm_tasks
             --hostname=test-worker@%h 
             --max-tasks-per-child=50 
             --time-limit=180 
             --soft-time-limit=150"
    environment:
      ENVIRONMENT: testing
      DATABASE_SERVICE: postgresql+asyncpg
      DATABASE_HOST: postgres-test
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-test_db}
      DATABASE_USER: ${DATABASE_USER:-test_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-test_password}
      CELERY_BROKER_URL: redis://redis-test:${REDIS_PORT:-6380}/0
      CELERY_RESULT_BACKEND: redis://redis-test:${REDIS_PORT:-6380}/1
      SECRET_KEY: ${SECRET_KEY:-test-secret-key-do-not-use-in-production}
      RUN_LLM_REAL_TESTS: ${RUN_LLM_REAL_TESTS:-0}
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network

  # PostgreSQL Database (Test)
  postgres-test:
    image: postgres:17
    container_name: ${APP_NAME:-inference-core-test}-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-test_db}
      POSTGRES_USER: ${DATABASE_USER:-test_user}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-test_password}
    ports:
      - '${DATABASE_PORT_POSTGRES:-55432}:5432'
    # Use tmpfs for ephemeral storage (no persistence)
    tmpfs:
      - /var/lib/postgresql/data:noexec,nosuid,size=500m
    networks:
      - test-network
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${DATABASE_USER:-test_user} -d ${DATABASE_NAME:-test_db}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis for Celery and App Sessions (Test)
  redis-test:
    image: redis:7-alpine
    container_name: ${APP_NAME:-inference-core-test}-redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6380}:${REDIS_PORT:-6380}'
    command: redis-server --appendonly no --port ${REDIS_PORT:-6380} --save ""
    # Use tmpfs for ephemeral storage (no persistence)
    tmpfs:
      - /data:noexec,nosuid,size=100m
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '${REDIS_PORT:-6380}', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  test-network:
    driver: bridge
    name: ${APP_NAME:-inference-core-test}-postgres-network
