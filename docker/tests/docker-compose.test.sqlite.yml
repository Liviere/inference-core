# Docker Compose for Isolated Test Environment - SQLite
# Ports: inference-core-test:8100, redis-test:6380, flower-test:5556 (optional)
# Usage: docker compose -f docker/tests/docker-compose.test.sqlite.yml --env-file .env.test.example up -d
# Cleanup: docker compose -f docker/tests/docker-compose.test.sqlite.yml down -v

name: ${APP_NAME:-inference-core-test}-sqlite

services:
  # Inference Core Application (Test)
  inference-core-test:
    build:
      context: ../..
      dockerfile: docker/tests/Dockerfile
    container_name: ${APP_NAME:-inference-core-test}-app
    restart: unless-stopped
    command:
      [
        'uvicorn',
        'inference_core.main_factory:create_application',
        '--factory',
        '--port',
        '${PORT:-8100}',
        '--host',
        '${HOST:-0.0.0.0}',
        '--workers',
        '2',
      ]
    ports:
      - '${PORT:-8100}:${PORT:-8100}'
    environment:
      ENVIRONMENT: testing
      APP_NAME: ${APP_NAME:-inference-core-test}
      APP_DESCRIPTION: ${APP_DESCRIPTION:-Test environment for Inference Core backend}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      DATABASE_SERVICE: sqlite+aiosqlite
      DATABASE_URL: sqlite+aiosqlite:///tmp/app_test.db
      CELERY_BROKER_URL: redis://redis-test:${REDIS_PORT:-6380}/0
      CELERY_RESULT_BACKEND: redis://redis-test:${REDIS_PORT:-6380}/1
      REDIS_URL: redis://redis-test:${REDIS_PORT:-6380}/10
      SECRET_KEY: ${SECRET_KEY:-test-secret-key-do-not-use-in-production}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      REDIS_REFRESH_PREFIX: ${REDIS_REFRESH_PREFIX:-test:auth:refresh:}
      RUN_LLM_REAL_TESTS: ${RUN_LLM_REAL_TESTS:-0}
      DEBUG: ${DEBUG:-false}
    networks:
      - test-network
    depends_on:
      redis-test:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          'http://localhost:${PORT:-8100}/api/v1/health/ping',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Celery Worker (Test)
  celery-worker-test:
    build:
      context: ../..
      dockerfile: docker/tests/Dockerfile
    container_name: ${APP_NAME:-inference-core-test}-celery-worker
    restart: unless-stopped
    command: >
      sh -c "poetry run celery -A inference_core.celery.celery_main:celery_app worker 
             --loglevel=info 
             --queues=default,llm_tasks
             --hostname=test-worker@%h 
             --max-tasks-per-child=50 
             --time-limit=180 
             --soft-time-limit=150"
    environment:
      ENVIRONMENT: testing
      DATABASE_SERVICE: sqlite+aiosqlite
      DATABASE_URL: sqlite+aiosqlite:///tmp/inference_core_test.db
      CELERY_BROKER_URL: redis://redis-test:${REDIS_PORT:-6380}/0
      CELERY_RESULT_BACKEND: redis://redis-test:${REDIS_PORT:-6380}/1
      SECRET_KEY: ${SECRET_KEY:-test-secret-key-do-not-use-in-production}
      RUN_LLM_REAL_TESTS: ${RUN_LLM_REAL_TESTS:-0}
    depends_on:
      redis-test:
        condition: service_healthy
    networks:
      - test-network

  # Redis for Celery and App Sessions (Test)
  redis-test:
    image: redis:7-alpine
    container_name: ${APP_NAME:-inference-core-test}-redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6380}:${REDIS_PORT:-6380}'
    command: redis-server --appendonly no --port ${REDIS_PORT:-6380} --save ""
    # Use tmpfs for ephemeral storage (no persistence)
    tmpfs:
      - /data:noexec,nosuid,size=100m
    networks:
      - test-network
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '${REDIS_PORT:-6380}', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  test-network:
    driver: bridge
    name: ${APP_NAME:-inference-core-test}-sqlite-network
