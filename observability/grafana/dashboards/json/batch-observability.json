{
	"__inputs": [
		{
			"name": "DS_PROMETHEUS",
			"label": "Prometheus",
			"description": "Prometheus datasource",
			"type": "datasource",
			"pluginId": "prometheus",
			"pluginName": "Prometheus"
		}
	],
	"__requires": [
		{
			"type": "grafana",
			"id": "grafana",
			"name": "Grafana",
			"version": "10.4.0"
		},
		{ "type": "panel", "id": "stat", "name": "Stat", "version": "1" },
		{
			"type": "panel",
			"id": "timeseries",
			"name": "Time series",
			"version": "1"
		},
		{ "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "1" },
		{ "type": "panel", "id": "table", "name": "Table", "version": "1" },
		{ "type": "panel", "id": "heatmap", "name": "Heatmap", "version": "1" },
		{ "type": "panel", "id": "gauge", "name": "Gauge", "version": "1" }
	],
	"title": "Batch Processing Observability",
	"uid": "batch-observability",
	"tags": ["batch", "llm", "observability"],
	"timezone": "browser",
	"schemaVersion": 39,
	"version": 1,
	"refresh": "30s",
	"templating": {
		"list": [
			{
				"name": "provider",
				"type": "query",
				"datasource": "${DS_PROMETHEUS}",
				"hide": 0,
				"refresh": 2,
				"sort": 1,
				"query": "label_values(batch_jobs_total, provider)",
				"definition": "label_values(batch_jobs_total, provider)",
				"multi": true,
				"includeAll": true,
				"allValue": ".*",
				"current": { "selected": false, "text": "All", "value": "$__all" }
			},
			{
				"name": "operation",
				"type": "query",
				"datasource": "${DS_PROMETHEUS}",
				"refresh": 2,
				"query": "label_values(batch_provider_latency_seconds_bucket, operation)",
				"multi": true,
				"includeAll": true,
				"allValue": ".*",
				"current": { "selected": false, "text": "All", "value": "$__all" }
			}
		]
	},
	"panels": [
		{
			"type": "row",
			"title": "Overview",
			"collapsed": false,
			"gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }
		},
		{
			"type": "stat",
			"title": "Jobs In Progress",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
			"targets": [
				{ "expr": "sum(batch_jobs_in_progress{provider=~\"$provider\"})" }
			]
		},
		{
			"type": "stat",
			"title": "Job Submissions (5m)",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
			"targets": [
				{
					"expr": "sum(increase(batch_jobs_total{status=\"submitted\",provider=~\"$provider\"}[5m]))"
				}
			]
		},
		{
			"type": "stat",
			"title": "Completed Jobs (1h)",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
			"targets": [
				{
					"expr": "sum(increase(batch_jobs_total{status=\"completed\",provider=~\"$provider\"}[1h]))"
				}
			]
		},
		{
			"type": "stat",
			"title": "Failed Jobs (1h)",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
			"targets": [
				{
					"expr": "sum(increase(batch_jobs_total{status=\"failed\",provider=~\"$provider\"}[1h]))"
				}
			]
		},
		{
			"type": "gauge",
			"title": "Item Success Rate (15m)",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
			"fieldConfig": {
				"defaults": { "unit": "percent", "min": 0, "max": 100 }
			},
			"targets": [
				{
					"expr": "100 * (sum(increase(batch_items_total{status=\"completed\",provider=~\"$provider\"}[15m])) / clamp_min(sum(increase(batch_items_total{provider=~\"$provider\"}[15m])),1))"
				}
			]
		},
		{
			"type": "bargauge",
			"title": "Jobs by Final Status (24h)",
			"datasource": "${DS_PROMETHEUS}",
			"gridPos": { "h": 8, "w": 8, "x": 0, "y": 5 },
			"targets": [
				{
					"expr": "sum(increase(batch_jobs_total{status=~\"completed|failed|cancelled\",provider=~\"$provider\"}[24h])) by (status)"
				}
			]
		},
		{
			"type": "timeseries",
			"title": "Provider Latency Avg (op)",
			"gridPos": { "h": 8, "w": 8, "x": 8, "y": 5 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "sum(rate(batch_provider_latency_seconds_sum{provider=~\"$provider\",operation=~\"$operation\"}[5m])) by (operation) / sum(rate(batch_provider_latency_seconds_count{provider=~\"$provider\",operation=~\"$operation\"}[5m])) by (operation)",
					"legendFormat": "{{operation}}"
				}
			]
		},
		{
			"type": "heatmap",
			"title": "Provider Latency Distribution",
			"gridPos": { "h": 8, "w": 8, "x": 16, "y": 5 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "sum(rate(batch_provider_latency_seconds_bucket{provider=~\"$provider\",operation=~\"$operation\"}[5m])) by (le)",
					"format": "heatmap"
				}
			]
		},
		{
			"type": "timeseries",
			"title": "Job Duration p50 / p95 / p99",
			"gridPos": { "h": 8, "w": 12, "x": 0, "y": 13 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "histogram_quantile(0.50, sum(rate(batch_job_duration_seconds_bucket{provider=~\"$provider\"}[5m])) by (le))",
					"legendFormat": "p50"
				},
				{
					"expr": "histogram_quantile(0.95, sum(rate(batch_job_duration_seconds_bucket{provider=~\"$provider\"}[5m])) by (le))",
					"legendFormat": "p95"
				},
				{
					"expr": "histogram_quantile(0.99, sum(rate(batch_job_duration_seconds_bucket{provider=~\"$provider\"}[5m])) by (le))",
					"legendFormat": "p99"
				}
			]
		},
		{
			"type": "timeseries",
			"title": "Poll Cycle Duration p95",
			"gridPos": { "h": 8, "w": 6, "x": 12, "y": 13 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "histogram_quantile(0.95, sum(rate(batch_poll_cycle_seconds_bucket[5m])) by (le))",
					"legendFormat": "p95"
				}
			]
		},
		{
			"type": "timeseries",
			"title": "Errors by Type (1h rate)",
			"gridPos": { "h": 8, "w": 6, "x": 18, "y": 13 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "sum(rate(batch_errors_total{provider=~\"$provider\"}[1h])) by (error_type)",
					"legendFormat": "{{error_type}}"
				}
			]
		},
		{
			"type": "timeseries",
			"title": "Retries by Reason (1h rate)",
			"gridPos": { "h": 8, "w": 12, "x": 0, "y": 21 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "sum(rate(batch_retry_attempts_total{provider=~\"$provider\"}[1h])) by (retry_reason)",
					"legendFormat": "{{retry_reason}}"
				}
			]
		},
		{
			"type": "table",
			"title": "Recent Job Status Increments (5m)",
			"gridPos": { "h": 8, "w": 12, "x": 12, "y": 21 },
			"datasource": "${DS_PROMETHEUS}",
			"targets": [
				{
					"expr": "sum(increase(batch_jobs_total{provider=~\"$provider\"}[5m])) by (status, provider)"
				}
			]
		}
	]
}
